

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>The 3d Dependent Data Description language &mdash; EverParse Manual  documentation</title>
  

  
  <link rel="stylesheet" href="static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'./',
              VERSION:'',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="static/jquery.js"></script>
        <script type="text/javascript" src="static/underscore.js"></script>
        <script type="text/javascript" src="static/doctools.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="3d: Dependent Data Descriptions for Verified Validation" href="3d.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> EverParse Manual
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="3d.html">3d: Dependent Data Descriptions for Verified Validation</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="3d.html#tl-dr-summary">tl;dr Summary</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="3d.html#the-3d-dependent-data-description-language">The 3d Dependent Data Description language</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">The 3d Dependent Data Description language</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#structs">Structs</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constraints">Constraints</a></li>
<li class="toctree-l4"><a class="reference internal" href="#bitfields">Bitfields</a></li>
<li class="toctree-l4"><a class="reference internal" href="#constants-and-enumerations">Constants and Enumerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parameterized-data-types">Parameterized data types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#tagged-unions">Tagged unions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#arrays">Arrays</a></li>
<li class="toctree-l4"><a class="reference internal" href="#actions">Actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#checking-3d-types-for-correspondence-with-existing-c-types">Checking 3d types for correspondence with existing C types</a></li>
<li class="toctree-l4"><a class="reference internal" href="#comments">Comments</a></li>
<li class="toctree-l4"><a class="reference internal" href="#adding-copyright-notices-to-produced-c-h-files">Adding copyright notices to produced .c/.h files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#modular-structure-and-files">Modular structure and files</a></li>
<li class="toctree-l4"><a class="reference internal" href="#a-fully-worked-example-tcp-segment-headers">A fully worked example: TCP Segment Headers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="3d.html#download-and-install">Download and install</a></li>
<li class="toctree-l2"><a class="reference internal" href="3d.html#run">Run</a></li>
<li class="toctree-l2"><a class="reference internal" href="3d.html#optional-from-the-sources">Optional: From the sources</a></li>
<li class="toctree-l2"><a class="reference internal" href="3d.html#licenses">Licenses</a></li>
</ul>
</li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">EverParse Manual</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="3d.html">3d: Dependent Data Descriptions for Verified Validation</a> &raquo;</li>
        
      <li>The 3d Dependent Data Description language</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">

           <div itemprop="articleBody">
            
  <blockquote>
<div></div></blockquote>
<div class="section" id="the-3d-dependent-data-description-language">
<span id="d-lang"></span><h1>The 3d Dependent Data Description language<a class="headerlink" href="#the-3d-dependent-data-description-language" title="Permalink to this headline">¶</a></h1>
<p>3d supports (nested) structs, constraints, enums, parameterized data
types, tagged or otherwise value-dependent unions, fixed-size arrays,
and variable-size arrays. In addition to data validation, 3d also
supports <em>local actions</em> to pass values read from the data structure,
or pointers to them, to the caller code.</p>
<div class="section" id="structs">
<h2>Structs<a class="headerlink" href="#structs" title="Permalink to this headline">¶</a></h2>
<p>We would like to extract a validator for a simple point type, with X
and Y coordinates. So we create a file, <code class="docutils literal notranslate"><span class="pre">HelloWorld.3d</span></code>, with the
following 3d data format description:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_point</span> <span class="p">{</span>
  <span class="n">UINT16</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">UINT16</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span> <span class="n">point</span><span class="p">;</span>
</pre></div>
</div>
<p>This data format is very similar to a C type description, where
<code class="docutils literal notranslate"><span class="pre">UINT16</span></code> denotes the type of unsigned 16-bit integers, represented
as little-endian; with the addition of the <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code> keyword,
which tells 3d to expose the validator for the type to the final user.</p>
<p>Once we run <code class="docutils literal notranslate"><span class="pre">3d</span></code> with this file, we obtain several files:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">HelloWorld.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HelloWorld.h</span></code>, which contain the actual verified
validators;</li>
<li><code class="docutils literal notranslate"><span class="pre">HelloWorldWrapper.c</span></code> and <code class="docutils literal notranslate"><span class="pre">HelloWorldWrapper.h</span></code>, which contain
entrypoint function definitions for data validators that the user
should ultimately use in their client code. More precisely, here is
the contents of <code class="docutils literal notranslate"><span class="pre">HelloWorldWrapper.h</span></code>:</li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">BOOLEAN</span> <span class="nf">HelloWorldCheckPoint</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">HelloWorldCheckPoint</span></code> function is the actual validator for the
<code class="docutils literal notranslate"><span class="pre">point</span></code> type. It takes an array of bytes, <code class="docutils literal notranslate"><span class="pre">base</span></code>, and its length
<code class="docutils literal notranslate"><span class="pre">len</span></code>, and it returns 1 if <code class="docutils literal notranslate"><span class="pre">base</span></code> starts with valid <code class="docutils literal notranslate"><span class="pre">point</span></code> data
that fits in <code class="docutils literal notranslate"><span class="pre">len</span></code> bytes or less, and 0 otherwise.</p>
<p>More generally, for a given <code class="docutils literal notranslate"><span class="pre">Module.3d</span></code>, a type definition <code class="docutils literal notranslate"><span class="pre">typ</span></code>
marked with <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code> tells 3d to expose its validator in
<code class="docutils literal notranslate"><span class="pre">ModuleWrapper.h</span></code> which will bear the name <code class="docutils literal notranslate"><span class="pre">ModuleCheckTyp</span></code>.</p>
<p>Structs can be nested, such as in the following instance:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_point</span> <span class="p">{</span>
  <span class="n">UINT16</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">UINT16</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span> <span class="n">point</span><span class="p">;</span>

<span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_triangle</span> <span class="p">{</span>
  <span class="n">point</span> <span class="n">a</span><span class="p">;</span>
  <span class="n">point</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">point</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span> <span class="n">triangle</span><span class="p">;</span>
</pre></div>
</div>
<p>Then, since in this file the definition of <code class="docutils literal notranslate"><span class="pre">point</span></code> is not prefixed
with <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code>, only <code class="docutils literal notranslate"><span class="pre">triangle</span></code> will have its validator exposed
in <code class="docutils literal notranslate"><span class="pre">TriangleWrapper.h</span></code>.</p>
<p>There can be multiple definitions marked <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code> in a given
<code class="docutils literal notranslate"><span class="pre">.3d</span></code> file.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>3d does not enforce any alignment constraints, and does not
introduce any implicit alignment padding. So, for instance, in the
following data format description:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_point</span> <span class="p">{</span>
  <span class="n">UINT16</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">UINT16</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span> <span class="n">point</span><span class="p">;</span>

<span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_coloredPoint1</span> <span class="p">{</span>
  <span class="n">UINT8</span> <span class="n">color</span><span class="p">;</span>
  <span class="n">point</span> <span class="n">pt</span><span class="p">;</span>
<span class="p">}</span> <span class="n">coloredPoint1</span><span class="p">;</span>

<span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_coloredPoint2</span> <span class="p">{</span>
  <span class="n">point</span> <span class="n">pt</span><span class="p">;</span>
  <span class="n">UINT8</span> <span class="n">color</span><span class="p">;</span>
<span class="p">}</span> <span class="n">coloredPoint2</span><span class="p">;</span>
</pre></div>
</div>
<ul class="last simple">
<li>in <code class="docutils literal notranslate"><span class="pre">coloredPoint1</span></code>, 3d will not introduce any padding between
the <code class="docutils literal notranslate"><span class="pre">color</span></code> field and the <code class="docutils literal notranslate"><span class="pre">pt</span></code> field;</li>
<li>in <code class="docutils literal notranslate"><span class="pre">coloredPoint2</span></code>, 3d will not introduce any padding after the
<code class="docutils literal notranslate"><span class="pre">color</span></code> field.</li>
</ul>
</div>
</div>
<div class="section" id="constraints">
<h2>Constraints<a class="headerlink" href="#constraints" title="Permalink to this headline">¶</a></h2>
<p>Validators for structs alone are only layout-related. Beyond that, 3d
provides a way to actually check for constraints on their field
values:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_smoker</span> <span class="p">{</span>
  <span class="n">UINT32</span> <span class="n">age</span> <span class="p">{</span> <span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">21</span> <span class="p">};</span>
  <span class="n">UINT8</span> <span class="n">cigarettesConsumed</span><span class="p">;</span>
<span class="p">}</span> <span class="n">smoker</span><span class="p">;</span>
</pre></div>
</div>
<p>In this example, the validator for <code class="docutils literal notranslate"><span class="pre">smoker</span></code> will check that the
value of the <code class="docutils literal notranslate"><span class="pre">age</span></code> field is at least 21.</p>
<p>The constraint language includes integer arithmetic (<code class="docutils literal notranslate"><span class="pre">+</span></code>, <code class="docutils literal notranslate"><span class="pre">-</span></code>,
<code class="docutils literal notranslate"><span class="pre">*</span></code>, <code class="docutils literal notranslate"><span class="pre">/</span></code>, <code class="docutils literal notranslate"><span class="pre">==</span></code>, <code class="docutils literal notranslate"><span class="pre">!=</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;=</span></code>, <code class="docutils literal notranslate"><span class="pre">&lt;</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;=</span></code>, <code class="docutils literal notranslate"><span class="pre">&gt;</span></code>) and
Boolean propositional logic (<code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code>, <code class="docutils literal notranslate"><span class="pre">||</span></code>, <code class="docutils literal notranslate"><span class="pre">!</span></code>)</p>
<p>Constraints on a field can also depend on the values of the previous
fields of the struct. For instance, here is a type definition for a
pair ordered by increasing values:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_orderedPair</span> <span class="p">{</span>
  <span class="n">UINT32</span> <span class="n">lesser</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">greater</span> <span class="p">{</span> <span class="n">lesser</span> <span class="o">&lt;=</span> <span class="n">greater</span> <span class="p">};</span>
<span class="p">}</span> <span class="n">orderedPair</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>Arithmetics on constraints are evaluated in machine integers, not
mathematical integers. Thus, the following naive definition:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_boundedSum</span> <span class="p">{</span>
  <span class="n">UINT32</span> <span class="n">left</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">right</span> <span class="p">{</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span> <span class="o">&lt;=</span> <span class="mi">42</span> <span class="p">};</span>
<span class="p">}</span> <span class="n">boundedSum</span><span class="p">;</span>
</pre></div>
</div>
<p>will fail at F* verification because the expression <code class="docutils literal notranslate"><span class="pre">left</span> <span class="pre">+</span> <span class="pre">right</span></code>
must be proven to not overflow <em>before</em> evaluating the condition. The
correct way of stating the condition is as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_boundedSum</span> <span class="p">{</span>
  <span class="n">UINT32</span> <span class="n">left</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">right</span> <span class="p">{</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="mi">42</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">&lt;=</span> <span class="mi">42</span> <span class="o">-</span> <span class="n">left</span> <span class="p">};</span>
<span class="p">}</span> <span class="n">boundedSum</span><span class="p">;</span>
</pre></div>
</div>
<p class="last">This verifies because F* evaluates the right-hand-side
condition of a <code class="docutils literal notranslate"><span class="pre">&amp;&amp;</span></code> in a context where the left-hand-side
condition is assumed to be true (thus <code class="docutils literal notranslate"><span class="pre">42</span> <span class="pre">-</span> <span class="pre">left</span></code> will not underflow.)</p>
</div>
</div>
<div class="section" id="bitfields">
<h2>Bitfields<a class="headerlink" href="#bitfields" title="Permalink to this headline">¶</a></h2>
<p>Like in C, the fields of a struct type in 3d can include bitfields,
i.e., unsigned integer types of user-specified width represented
packed within unsigned integer fields of the canonical sizes
UINT16, UINT32 and UINT64.</p>
<p>Consider the following example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_BF</span> <span class="p">{</span>
  <span class="n">UINT32</span> <span class="nl">x</span> <span class="p">:</span> <span class="mi">6</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="nl">y</span> <span class="p">:</span> <span class="mi">10</span> <span class="p">{</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="mi">900</span> <span class="p">};</span>
  <span class="n">UINT32</span> <span class="nl">z</span> <span class="p">:</span> <span class="mi">16</span> <span class="p">{</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span> <span class="o">&lt;=</span> <span class="mi">60000</span> <span class="p">}</span>
<span class="p">}</span> <span class="n">BF</span><span class="p">;</span>
</pre></div>
</div>
<p>This defines a struct <code class="docutils literal notranslate"><span class="pre">BF</span></code> occupying 32 bits of memory, where the
first 6 bits are for the field <code class="docutils literal notranslate"><span class="pre">x</span></code>; the next 10 bits are for the
field <code class="docutils literal notranslate"><span class="pre">y</span></code>; and the following 16 bits are for the field <code class="docutils literal notranslate"><span class="pre">z</span></code>.</p>
<p>The fields <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code>, and <code class="docutils literal notranslate"><span class="pre">z</span></code> can all be used in specifications
and are implicitly promoted to the underlying integer type, <code class="docutils literal notranslate"><span class="pre">UINT32</span></code>
in this case, although the 3d verifier is aware of suitable bounds on
the types, e.g., that <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">&lt;=</span> <span class="pre">x</span> <span class="pre">&lt;</span> <span class="pre">64</span></code>.</p>
<p>3d implements C’s rules for packing bit fields. For instance,</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_BF2</span> <span class="p">{</span>
  <span class="n">UINT16</span> <span class="nl">x</span> <span class="p">:</span> <span class="mi">6</span><span class="p">;</span>
  <span class="n">UINT16</span> <span class="nl">y</span> <span class="p">:</span> <span class="mi">12</span><span class="p">;</span>
  <span class="n">UINT8</span> <span class="n">z</span><span class="p">;</span>
<span class="p">}</span> <span class="n">BF2</span><span class="p">;</span>
</pre></div>
</div>
<p>In <code class="docutils literal notranslate"><span class="pre">BF2</span></code>, although <code class="docutils literal notranslate"><span class="pre">x</span></code>, <code class="docutils literal notranslate"><span class="pre">y</span></code> and <code class="docutils literal notranslate"><span class="pre">z</span></code> cumulatively consume only
26 bits, the layout of <code class="docutils literal notranslate"><span class="pre">BF2</span></code> is actually as shown below, consuming
40 bits, since a given field must be represented within the bounds of
a single underlying type—we have 10 unused bits after <code class="docutils literal notranslate"><span class="pre">x</span></code> and 4
unused bits after <code class="docutils literal notranslate"><span class="pre">y</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>                   <span class="mi">4</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span>
<span class="o">|</span>     <span class="n">x</span>     <span class="o">|</span>       <span class="n">Unused</span>      <span class="o">|</span>           <span class="n">y</span>           <span class="o">|</span><span class="n">Unused</span> <span class="o">|</span>        <span class="n">z</span>      <span class="o">|</span>
<span class="o">|</span>           <span class="o">|</span>                   <span class="o">|</span>                       <span class="o">|</span>       <span class="o">|</span>               <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-</span>
</pre></div>
</div>
</div>
<div class="section" id="constants-and-enumerations">
<h2>Constants and Enumerations<a class="headerlink" href="#constants-and-enumerations" title="Permalink to this headline">¶</a></h2>
<p>3d provides a way to define numerical constants:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define red   1</span>
<span class="cp">#define green 2</span>
<span class="cp">#define blue  42</span>
</pre></div>
</div>
<p>Alternatively, 3d provides a way to define enumerated types:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">UINT32</span> <span class="k">enum</span> <span class="n">color</span> <span class="p">{</span>
  <span class="n">red</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">green</span><span class="p">,</span>
  <span class="n">blue</span> <span class="o">=</span> <span class="mi">42</span>
<span class="p">}</span>

<span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_coloredPoint</span> <span class="p">{</span>
  <span class="n">color</span> <span class="n">col</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">x</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">y</span><span class="p">;</span>
<span class="p">}</span> <span class="n">coloredPoint</span><span class="p">;</span>
</pre></div>
</div>
<p>The validator for <code class="docutils literal notranslate"><span class="pre">coloredPoint</span></code> will check that the value of
the field <code class="docutils literal notranslate"><span class="pre">col</span></code> is either 1, 2 (for <code class="docutils literal notranslate"><span class="pre">green</span></code>), or 42.</p>
<p>Contrary to structs, enum types cannot be marked <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code>.</p>
<p>The first enum label must be associated with a value.</p>
<p>The support type (here <code class="docutils literal notranslate"><span class="pre">UINT32</span></code>) must be the same type as the type
of the values associated to each label.</p>
<p>Due to a limitation in the way 3d currently checks for the absence of
double-fetches, values with enum type cannot be used in
constraints. For example, the following code is currently rejected.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">UINT32</span> <span class="k">enum</span> <span class="n">color</span> <span class="p">{</span>
  <span class="n">red</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
  <span class="n">green</span><span class="p">,</span>
  <span class="n">blue</span> <span class="o">=</span> <span class="mi">42</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_enum_constraint</span> <span class="p">{</span>
  <span class="n">color</span> <span class="n">col</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">x</span>
  <span class="p">{</span>
     <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">color</span> <span class="o">==</span> <span class="n">green</span>
  <span class="p">};</span>
<span class="p">}</span> <span class="n">_enum_constraint</span> <span class="p">;</span>
</pre></div>
</div>
<p>With the following error message:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">Error</span><span class="p">)</span> <span class="n">The</span> <span class="n">type</span> <span class="n">of</span> <span class="n">this</span> <span class="n">field</span> <span class="n">does</span> <span class="n">not</span> <span class="n">have</span> <span class="n">a</span> <span class="n">reader</span><span class="p">,</span> <span class="n">either</span> <span class="n">because</span> <span class="n">its</span> <span class="n">values</span> <span class="n">are</span> <span class="n">too</span> <span class="n">large</span> <span class="n">or</span> <span class="n">because</span> <span class="n">reading</span> <span class="n">it</span> <span class="n">may</span> <span class="n">incur</span> <span class="n">a</span> <span class="kt">double</span> <span class="n">fetch</span><span class="p">;</span> <span class="n">subsequent</span> <span class="n">fields</span> <span class="n">cannot</span> <span class="n">depend</span> <span class="n">on</span> <span class="n">it</span>
</pre></div>
</div>
<p>One must instead write:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UINT32</span> <span class="n">enum</span> <span class="n">color</span> <span class="p">{</span>
    <span class="n">red</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">green</span><span class="p">,</span>
    <span class="n">blue</span> <span class="o">=</span> <span class="mi">42</span>
<span class="p">};</span>

<span class="n">entrypoint</span>
<span class="n">typedef</span> <span class="n">struct</span> <span class="n">_enum_constraint</span> <span class="p">{</span>
    <span class="n">UINT32</span> <span class="n">col</span>
    <span class="p">{</span>
       <span class="n">col</span> <span class="o">==</span> <span class="n">red</span> <span class="o">||</span>
       <span class="n">col</span> <span class="o">==</span> <span class="n">green</span> <span class="o">||</span>
       <span class="n">col</span> <span class="o">==</span> <span class="n">blue</span>
    <span class="p">};</span>
    <span class="n">UINT32</span> <span class="n">x</span>
    <span class="p">{</span>
       <span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">col</span> <span class="o">==</span> <span class="n">green</span>
    <span class="p">};</span>
<span class="p">}</span> <span class="n">_enum_constraint</span> <span class="p">;</span>
</pre></div>
</div>
<p>We expect to lift this limitation soon.</p>
</div>
<div class="section" id="parameterized-data-types">
<h2>Parameterized data types<a class="headerlink" href="#parameterized-data-types" title="Permalink to this headline">¶</a></h2>
<p>3d also offers the possibility to parameterize a data type description
with arguments that can then be reused in constraints. For instance,
the following <code class="docutils literal notranslate"><span class="pre">BoundedSum.3d</span></code> data description defines a pair of two
integers whose sum is bounded by a bound provided by the user as
argument:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_boundedSum</span> <span class="p">(</span><span class="n">UINT32</span> <span class="n">bound</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">UINT32</span> <span class="n">left</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">right</span> <span class="p">{</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="o">-</span> <span class="n">left</span> <span class="p">};</span>
<span class="p">}</span> <span class="n">boundedSum</span><span class="p">;</span>
</pre></div>
</div>
<p>Then, these arguments will show up as arguments of the
corresponding validator in the <code class="docutils literal notranslate"><span class="pre">BoundedSumWrapper.h</span></code> header produced
by 3d:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">BOOLEAN</span> <span class="nf">BoundedSumCheckBoundedSum</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bound</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="n">base</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">len</span><span class="p">);</span>
</pre></div>
</div>
<p>Parameterized data types can also be instantiated within the <code class="docutils literal notranslate"><span class="pre">.3d</span></code>
file itself, including by the value of the field of a struct:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">mySum</span> <span class="p">{</span>
  <span class="n">UINT32</span> <span class="n">bound</span><span class="p">;</span>
  <span class="n">boundedSum</span><span class="p">(</span><span class="n">bound</span><span class="p">)</span> <span class="n">sum</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mySum</span><span class="p">;</span>
</pre></div>
</div>
<p>A parameterized data type can also check whether a condition on its
arguments holds before even trying to check its contents:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_boundedSum</span> <span class="p">(</span><span class="n">UINT32</span> <span class="n">bound</span><span class="p">)</span>
<span class="n">where</span> <span class="n">bound</span> <span class="o">&lt;=</span> <span class="mi">1729</span>
<span class="p">{</span>
  <span class="n">UINT32</span> <span class="n">left</span><span class="p">;</span>
  <span class="n">UINT32</span> <span class="n">right</span> <span class="p">{</span> <span class="n">left</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="o">&amp;&amp;</span> <span class="n">right</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="o">-</span> <span class="n">left</span> <span class="p">};</span>
<span class="p">}</span> <span class="n">boundedSum</span><span class="p">;</span>
</pre></div>
</div>
<p>In this case, the validator for <code class="docutils literal notranslate"><span class="pre">boundedSum</span></code> would check
that <code class="docutils literal notranslate"><span class="pre">bound</span> <span class="pre">&lt;=</span> <span class="pre">1729</span></code>, before validating its fields.</p>
</div>
<div class="section" id="tagged-unions">
<h2>Tagged unions<a class="headerlink" href="#tagged-unions" title="Permalink to this headline">¶</a></h2>
<p>3d supports <em>tagged unions</em>: a data type can store a value named <em>tag</em>
and a <em>payload</em> whose type depends on the tag value. The tag does not
need to be stored with the payload (e.g. it could be a parameter to the
type).</p>
<p>For instance, the following description defines the type of an integer
prefixed by its size in bits.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define size8  8</span>
<span class="cp">#define size16 16</span>
<span class="cp">#define size32 32</span>

<span class="n">casetype</span> <span class="nf">_int_payload</span> <span class="p">(</span><span class="n">UINT32</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">size8</span><span class="p">:</span>  <span class="n">UINT8</span>  <span class="n">value8</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">size16</span><span class="p">:</span> <span class="n">UINT16</span> <span class="n">value16</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">size32</span><span class="p">:</span> <span class="n">UINT32</span> <span class="n">value32</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">int_payload</span><span class="p">;</span>

<span class="n">entrypoint</span> <span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_integer</span> <span class="p">{</span>
  <span class="n">UINT32</span>                <span class="n">size</span><span class="p">;</span>
  <span class="n">int_payload</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="n">payload</span><span class="p">;</span>
<span class="p">}</span> <span class="n">integer</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">3d does not enforce that all cases of a union be of the same size,
and 3d does not introduce any implicit padding to enforce it. Nor
does 3d introduce any alignment padding. This is in the spirit of
keeping 3d specifications explicit: if you want padding, you need to
add it explicitly.</p>
</div>
<p>A <code class="docutils literal notranslate"><span class="pre">casetype</span></code> type actually defines an untagged union type dependent
on an argument value, which can be reused, e.g. for several types that
put different constraints on the value of the tag.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">casetype</span></code> type can also be marked <code class="docutils literal notranslate"><span class="pre">entrypoint</span></code>.</p>
</div>
<div class="section" id="arrays">
<h2>Arrays<a class="headerlink" href="#arrays" title="Permalink to this headline">¶</a></h2>
<p>A field in a struct or a casetype can be an array.</p>
<p>Arrays in 3d differ from arrays in C in a few important ways:</p>
<ul class="simple">
<li>Rather than counting elements, the size of an array in 3d is always
given in bytes.</li>
<li>Array sizes need not be a constant expression: any integer
expression is permissible for an array, so long as it fits in
<code class="docutils literal notranslate"><span class="pre">UINT32</span></code>. This allows expressing variable-sized arrays.</li>
</ul>
<p>3d supports several kinds of arrays.</p>
<div class="section" id="byte-sized-arrays">
<h3>Byte-sized arrays<a class="headerlink" href="#byte-sized-arrays" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">f[:byte-size</span> <span class="pre">n]</span></code></li>
</ul>
<p>The notation <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">f[:byte-size</span> <span class="pre">n]</span></code> describes a field named <code class="docutils literal notranslate"><span class="pre">f</span></code> holding an
array of elements of type <code class="docutils literal notranslate"><span class="pre">T</span></code> whose cumulative size in bytes is <code class="docutils literal notranslate"><span class="pre">n</span></code>.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">sizeof(T)</span> <span class="pre">=</span> <span class="pre">1</span></code>, 3d supports the notation <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">f[n]</span></code>, i.e., for
byte arrays, since the byte size and element count coincide, you need
not qualify the size of the array with a <code class="docutils literal notranslate"><span class="pre">:byte-size</span></code> qualifier.</p>
</div>
<div class="section" id="upper-bounded-byte-sized-arrays">
<h3>Upper-bounded byte-sized arrays<a class="headerlink" href="#upper-bounded-byte-sized-arrays" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">f[:byte-size-at-most</span> <span class="pre">n]</span></code></li>
</ul>
<p>Sometimes, it is required to specify that a variable size array has a
cumulative length that fits within some given byte size bound. This
can be specified in 3d using the notation above, which introduces a
field <code class="docutils literal notranslate"><span class="pre">f</span></code> of <code class="docutils literal notranslate"><span class="pre">T</span></code>-typed elements whose cumulative size in bytes
less than or equal to <code class="docutils literal notranslate"><span class="pre">n</span></code>.</p>
</div>
<div class="section" id="singleton-arrays-of-variable-size">
<h3>Singleton arrays of variable size<a class="headerlink" href="#singleton-arrays-of-variable-size" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">f[:byte-size-single-element-array</span> <span class="pre">n]</span></code></li>
</ul>
<p>In some cases, it is required to specify that a field contains a
single variable-sized element whose size in bytes is equal to a given
expression. The notation above introduces a field <code class="docutils literal notranslate"><span class="pre">f</span></code> that contains
a single element of type <code class="docutils literal notranslate"><span class="pre">T</span></code> occupying exactly <code class="docutils literal notranslate"><span class="pre">n</span></code> bytes.</p>
<p>We expect to add several other kinds of variable-length array-like
types in the uture.</p>
</div>
</div>
<div class="section" id="actions">
<h2>Actions<a class="headerlink" href="#actions" title="Permalink to this headline">¶</a></h2>
<p>In addition to semantic constraints on types, 3d allows augmenting the
the fields of a struct or union with imperative actions, which allows
running certain user-chosen commands at specified points during
validation.</p>
<p>Let’s start with a simple example. Suppose you want to validate that a
byte array contains a pair of integers, and then read them into a
couple of mutable locations of your choosing. Here’s how:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_Pair</span><span class="p">(</span><span class="n">mutable</span> <span class="n">UINT32</span><span class="o">*</span> <span class="n">x</span><span class="p">,</span>
                     <span class="n">mutable</span> <span class="n">UINT32</span><span class="o">*</span> <span class="n">y</span><span class="p">)</span>
<span class="p">{</span>
   <span class="n">UINT32</span> <span class="n">first</span>
   <span class="p">{</span><span class="o">:</span><span class="n">on</span><span class="o">-</span><span class="n">success</span>
        <span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">first</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">};</span>

   <span class="n">UINT32</span> <span class="n">second</span>
   <span class="p">{</span><span class="o">:</span><span class="n">on</span><span class="o">-</span><span class="n">success</span>
        <span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">second</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
   <span class="p">};</span>
<span class="p">}</span> <span class="n">Pair</span><span class="p">;</span>
</pre></div>
</div>
<p>The struct <code class="docutils literal notranslate"><span class="pre">Pair</span></code> takes two out-parameters, <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>. Out
parameters are signified by the <code class="docutils literal notranslate"><span class="pre">mutable</span></code> keyword and have pointer
types—in this case <code class="docutils literal notranslate"><span class="pre">UINT32*</span></code>. Each field in the struct is
augmented with an <code class="docutils literal notranslate"><span class="pre">on-success</span></code> action, where the action’s body is a
runs a small program snippet, which writes the <code class="docutils literal notranslate"><span class="pre">first</span></code> field into
<code class="docutils literal notranslate"><span class="pre">x</span></code>; the <code class="docutils literal notranslate"><span class="pre">second</span></code> field into <code class="docutils literal notranslate"><span class="pre">y</span></code>; and returns <code class="docutils literal notranslate"><span class="pre">true</span></code> in both
cases. Actions can also return <code class="docutils literal notranslate"><span class="pre">false</span></code>, to signal that validation
should halt and signal failure.</p>
<p>Now, in greater detail:</p>
<div class="section" id="action-basics">
<h3>Action basics<a class="headerlink" href="#action-basics" title="Permalink to this headline">¶</a></h3>
<p>An action is a program composed from a few elements:</p>
<ul class="simple">
<li>Atomic actions: Basic commands to read and write variables</li>
<li>Variable bindings and sequential composition</li>
<li>Conditionals</li>
</ul>
<p>An action is evaluated with respect to a handler (e.g.,
<code class="docutils literal notranslate"><span class="pre">on-success</span></code>) associated with a given field. We refer to this field
as the “base field” of the action.</p>
<p>An action is invoked by EverParse immediately after validating the
base field of the action. The action of the <code class="docutils literal notranslate"><span class="pre">on-success</span></code> handler is
invoked in case the field is valid (if preseent), otherwise the
<code class="docutils literal notranslate"><span class="pre">on-error</span></code> handler is invoked (if present).</p>
<p>The on-success handler can influence whether or not validation of the
other fields continues by returning a boolean—in case an on-success
action returns false, the validation of the type halts with an error.</p>
<p>The on-error handler also returns a boolean: in case it returns false,
the error code associated with the validator mentions that an
on-error handler failed; if it returns true, the error code is the
error code associated with the failed validation of the base field. In
both cases, validation halts with an error.</p>
<div class="section" id="atomic-actions">
<h4>Atomic actions<a class="headerlink" href="#atomic-actions" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Expression <code class="docutils literal notranslate"><span class="pre">e</span></code> consist of variables and constants.</li>
<li><code class="docutils literal notranslate"><span class="pre">*i</span> <span class="pre">=</span> <span class="pre">e</span></code>: Assigns the value of the expressions <code class="docutils literal notranslate"><span class="pre">e</span></code> to the memory referenced by the pointer <code class="docutils literal notranslate"><span class="pre">i</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">*i</span></code>: Dereferences the pointer <code class="docutils literal notranslate"><span class="pre">i</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">field_pos</span></code>: Returns the offset of base field of the action from
the base of the validation buffer as a <code class="docutils literal notranslate"><span class="pre">UINT32</span></code> value.</li>
<li><code class="docutils literal notranslate"><span class="pre">field_ptr</span></code>: Returns a pointer to base field of the action as a
<code class="docutils literal notranslate"><span class="pre">PUINT8</span></code>, i.e., an abstract pointer to a <code class="docutils literal notranslate"><span class="pre">UINT8</span></code>.</li>
<li><code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">e</span></code> Returns a boolean value <code class="docutils literal notranslate"><span class="pre">e</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">abort</span></code>: Causes the current validation process to fail.</li>
</ul>
<p>We plan to support additional user-defined actions as callbacks to
external C functions.</p>
</div>
<div class="section" id="composing-atomic-actions-sequentially-and-conditionally">
<h4>Composing atomic actions sequentially and conditionally<a class="headerlink" href="#composing-atomic-actions-sequentially-and-conditionally" title="Permalink to this headline">¶</a></h4>
<p>Composite actions can be built in a few ways:</p>
<ul class="simple">
<li>Atomic actions: For any atomic action <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">a;</span></code> (with a trailing
semicolon) is a composite action <code class="docutils literal notranslate"><span class="pre">p</span></code>.</li>
<li>Sequential composition: <code class="docutils literal notranslate"><span class="pre">`a;</span> <span class="pre">p</span></code> Given an atomic action <code class="docutils literal notranslate"><span class="pre">a</span></code>, and
a compositite action <code class="docutils literal notranslate"><span class="pre">p</span></code>, the form <code class="docutils literal notranslate"><span class="pre">a;p</span></code> runs <code class="docutils literal notranslate"><span class="pre">a</span></code> then <code class="docutils literal notranslate"><span class="pre">p</span></code>.</li>
<li>Variable binding: <code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">a;</span> <span class="pre">p</span></code> Given an atomic action <code class="docutils literal notranslate"><span class="pre">a</span></code>,
and a compositite action <code class="docutils literal notranslate"><span class="pre">p</span></code>, the form <code class="docutils literal notranslate"><span class="pre">var</span> <span class="pre">x</span> <span class="pre">=</span> <span class="pre">a;</span> <span class="pre">p</span></code> runs <code class="docutils literal notranslate"><span class="pre">a</span></code>,
stores its result in the new variable <code class="docutils literal notranslate"><span class="pre">x</span></code> (local to the
action), and then runs <code class="docutils literal notranslate"><span class="pre">p</span></code> (where <code class="docutils literal notranslate"><span class="pre">p</span></code> may mention <cite>x</cite></li>
<li>Conditionals: <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(e)</span> <span class="pre">{</span> <span class="pre">p</span> <span class="pre">}</span></code> is a conditional action that runs the
composite actions <code class="docutils literal notranslate"><span class="pre">p</span></code> only if the condition <code class="docutils literal notranslate"><span class="pre">e</span></code> is
true. Additionally, <code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(e)</span> <span class="pre">{</span> <span class="pre">p0</span> <span class="pre">}</span> <span class="pre">else</span> <span class="pre">{</span> <span class="pre">p1</span> <span class="pre">}</span></code> is also legal,
with the expected semantics, i.e., <code class="docutils literal notranslate"><span class="pre">p1`</span> <span class="pre">is</span> <span class="pre">run</span> <span class="pre">in</span> <span class="pre">case</span> <span class="pre">``e</span></code> is
false.</li>
</ul>
</div>
<div class="section" id="another-example">
<h4>Another example<a class="headerlink" href="#another-example" title="Permalink to this headline">¶</a></h4>
<p>Consider the following definition:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_T</span><span class="p">(</span><span class="n">mutable</span> <span class="n">PUINT8</span><span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UINT8</span> <span class="n">f1</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="n">UINT8</span> <span class="n">f2</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
    <span class="p">{</span><span class="o">:</span><span class="n">on</span><span class="o">-</span><span class="n">success</span>
        <span class="n">var</span> <span class="n">x</span> <span class="o">=</span> <span class="n">field_ptr</span><span class="p">;</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span> <span class="n">T</span><span class="p">;</span>
</pre></div>
</div>
<p>Here, we define a type <code class="docutils literal notranslate"><span class="pre">T</span></code> with an out-parameter <code class="docutils literal notranslate"><span class="pre">PUINT8*</span> <span class="pre">out</span></code>,
i.e., pointer to a pointer to a <code class="docutils literal notranslate"><span class="pre">UINT8</span></code>.</p>
<p>Associated with field <code class="docutils literal notranslate"><span class="pre">f2</span></code> we have an on-success handler, where we
read a pointer to the field <code class="docutils literal notranslate"><span class="pre">f2</span></code> into the local variable <code class="docutils literal notranslate"><span class="pre">x</span></code>;
then, we write <code class="docutils literal notranslate"><span class="pre">x</span></code> into <code class="docutils literal notranslate"><span class="pre">*out</span></code>; and finally return <code class="docutils literal notranslate"><span class="pre">true</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The return type of <code class="docutils literal notranslate"><span class="pre">field_ptr</span></code> is <code class="docutils literal notranslate"><span class="pre">PUINT8</span></code>. In
EverParse, a <code class="docutils literal notranslate"><span class="pre">PUINT8</span></code> is a pointer into the input buffer, unlike
a <code class="docutils literal notranslate"><span class="pre">UINT8*</span></code> which may point to any other memory. This distinction
between pointers into the input buffer and other pointers allows
EverParse to prove that validators never read the contents of the
input buffer more than once, i.e., there are no double fetches from
the input buffer. As such, the <code class="docutils literal notranslate"><span class="pre">out</span></code> parameter should have type
<code class="docutils literal notranslate"><span class="pre">PUINT8*</span></code> rather than <code class="docutils literal notranslate"><span class="pre">UINT8*</span></code>.</p>
</div>
</div>
</div>
<div class="section" id="restrictions">
<h3>Restrictions<a class="headerlink" href="#restrictions" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Actions can only be associated with fields.</li>
<li>Actions cannot be associated with the elements of an array, unless
the array elements themselves are defined types, in which case they
can be associated with the fields of that type, if any.</li>
<li>Actions cannot be associated with bit fields.</li>
</ul>
</div>
</div>
<div class="section" id="checking-3d-types-for-correspondence-with-existing-c-types">
<h2>Checking 3d types for correspondence with existing C types<a class="headerlink" href="#checking-3d-types-for-correspondence-with-existing-c-types" title="Permalink to this headline">¶</a></h2>
<p>A typical scenario is that you have an existing C program with some
collection of types defined in a file <code class="docutils literal notranslate"><span class="pre">Types.h</span></code>.  You’ve written a
<code class="docutils literal notranslate"><span class="pre">Types.3d</span></code> file to defined validators for byte buffers containing
those types, typically <em>refining</em> the C types with additional semantic
constraints and also with actions. Now, you may want to make sure that
types you defined in <code class="docutils literal notranslate"><span class="pre">Types.3d</span></code> correspond to the types in
<code class="docutils literal notranslate"><span class="pre">Types.h</span></code>, e.g., to ensure that you didn’t forget to include a field
in a struct, or that you’ve made explicit in your <code class="docutils literal notranslate"><span class="pre">Types.3d</span></code> the
alignment padding between struct fields that a C compiler is sometimes
requires to insert.</p>
<p>To assist with this, 3d provides the following feature:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// SNIPPET_START: GetFieldPtr.T</span>
<span class="n">entrypoint</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_T</span><span class="p">(</span><span class="n">mutable</span> <span class="n">PUINT8</span><span class="o">*</span> <span class="n">out</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">UINT8</span> <span class="n">f1</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
    <span class="n">UINT8</span> <span class="n">f2</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span>
    <span class="p">{</span><span class="o">:</span><span class="n">on</span><span class="o">-</span><span class="n">success</span>
        <span class="n">var</span> <span class="n">x</span> <span class="o">=</span> <span class="n">field_ptr</span><span class="p">;</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">}</span> <span class="n">T</span><span class="p">;</span>
<span class="c1">// SNIPPET_END: GetFieldPtr.T</span>

<span class="n">refining</span> <span class="s">&quot;GetFieldPtrBase.h&quot;</span> <span class="p">{</span>
   <span class="n">S</span> <span class="n">as</span> <span class="n">T</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Following the type definitions, the <code class="docutils literal notranslate"><span class="pre">refining</span></code> section states that
the type <code class="docutils literal notranslate"><span class="pre">S</span></code> defined in the C header file <code class="docutils literal notranslate"><span class="pre">GetFieldPtrBase.h</span></code> is
refined by the type <code class="docutils literal notranslate"><span class="pre">T</span></code> defined here. As a result of this
declaration, 3d emits a static assertion in the C code of the form</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span> <span class="cpf">&quot;GetFieldPtrBase.h&quot;</span><span class="cp"></span>
<span class="n">C_ASSERT</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">==</span> <span class="mi">30</span><span class="p">);</span>
</pre></div>
</div>
<p>checking that the <code class="docutils literal notranslate"><span class="pre">sizeof(S)</span></code> as computed by the C compiler matches
3d’s computation of the <code class="docutils literal notranslate"><span class="pre">sizeof(T)</span></code>.</p>
<p>In generality, the refining declaration takes the following form:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">refining</span> <span class="s">&quot;I1.h&quot;</span><span class="p">,</span> <span class="p">...,</span> <span class="s">&quot;In.h&quot;</span> <span class="p">{</span>
    <span class="n">S1</span> <span class="n">as</span> <span class="n">T1</span><span class="p">,</span> <span class="p">...</span>
    <span class="n">Sm</span> <span class="n">as</span> <span class="n">Tm</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where each <code class="docutils literal notranslate"><span class="pre">Si</span></code> is a type defined in one of the C header files
“I1.h”, …, “In.h”, and the <code class="docutils literal notranslate"><span class="pre">Ti</span></code> are types defined in the current
3d file. In case the types have the same names, one can simply write
<code class="docutils literal notranslate"><span class="pre">T</span></code> instead of <code class="docutils literal notranslate"><span class="pre">T</span> <span class="pre">as</span> <span class="pre">T</span></code>.</p>
</div>
<div class="section" id="comments">
<h2>Comments<a class="headerlink" href="#comments" title="Permalink to this headline">¶</a></h2>
<p>The user can insert comments in their <code class="docutils literal notranslate"><span class="pre">.3d</span></code> file, some of which will
be inserted into the <code class="docutils literal notranslate"><span class="pre">.c</span></code> file:</p>
<p>There are three kinds of comments:</p>
<ul class="simple">
<li>Block comments are delimited by <code class="docutils literal notranslate"><span class="pre">/*</span></code> and <code class="docutils literal notranslate"><span class="pre">*/</span></code> and do not
nest. These are never propagated to the C code.</li>
<li>Line comments begin with <code class="docutils literal notranslate"><span class="pre">//</span></code> and are propagated to C
heuristically close to the translated source construct.</li>
<li>Each top-level declaration can be preceded by a type declaration
comment delimited by <code class="docutils literal notranslate"><span class="pre">/*++</span></code> and <code class="docutils literal notranslate"><span class="pre">--*/</span></code>: These are propagated to
the C code preceding the C procedure corresponding to the validator
of the source type.</li>
</ul>
</div>
<div class="section" id="adding-copyright-notices-to-produced-c-h-files">
<h2>Adding copyright notices to produced .c/.h files<a class="headerlink" href="#adding-copyright-notices-to-produced-c-h-files" title="Permalink to this headline">¶</a></h2>
<p>If, along with some <code class="docutils literal notranslate"><span class="pre">MyFile.3d</span></code>, in the same directory, you provide
a file <code class="docutils literal notranslate"><span class="pre">MyFile.3d.copyright.txt</span></code> that contains syntactically correct
C comments (with <code class="docutils literal notranslate"><span class="pre">//</span></code> or <code class="docutils literal notranslate"><span class="pre">/*</span> <span class="pre">...</span> <span class="pre">*/</span></code>), then EverParse will prepend
<code class="docutils literal notranslate"><span class="pre">MyFile.c</span></code>, <code class="docutils literal notranslate"><span class="pre">MyFileWrapper.c</span></code> and their corresponding <code class="docutils literal notranslate"><span class="pre">.h</span></code> with
these comments. You do not need to mention this file on the command
line.</p>
<p>These comments can contain the following special symbols:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">EVERPARSEVERSION</span></code>, which EverParse will automatically replace
with its version number;</li>
<li><code class="docutils literal notranslate"><span class="pre">FILENAME</span></code>, which EverParse will automatically replace with the
name of the <code class="docutils literal notranslate"><span class="pre">.c</span></code> / <code class="docutils literal notranslate"><span class="pre">.h</span></code> file being generated.</li>
<li><code class="docutils literal notranslate"><span class="pre">EVERPARSEHASHES</span></code>, which EverParse will automatically replace with
a hash of the contents of the corresponding .3d file for the purpose
of <code class="docutils literal notranslate"><span class="pre">--check_hashes</span> <span class="pre">inplace</span></code> or <code class="docutils literal notranslate"><span class="pre">--check_inplace_hash</span></code> (see <a class="reference external" href="3d.html#alternate-mode-hash-checking">Hash
checking</a>).</li>
</ul>
</div>
<div class="section" id="modular-structure-and-files">
<h2>Modular structure and files<a class="headerlink" href="#modular-structure-and-files" title="Permalink to this headline">¶</a></h2>
<p>A 3d specification is described in a collection of modules, each
stored in a file with a <code class="docutils literal notranslate"><span class="pre">.3d</span></code> extension. The name of a module is
derived from its filename, i.e., the file <code class="docutils literal notranslate"><span class="pre">A.3d</span></code> defines a module
named <code class="docutils literal notranslate"><span class="pre">A</span></code>. A module can <code class="docutils literal notranslate"><span class="pre">Derived</span></code> (in Derived.3d) can refer to
another module <code class="docutils literal notranslate"><span class="pre">Base</span></code> (in Base.3d) by its name, allowing definitions
in <code class="docutils literal notranslate"><span class="pre">Derived</span></code> to reuse the definitions that are exported in <code class="docutils literal notranslate"><span class="pre">Base</span></code>.</p>
<p>For example, in module <code class="docutils literal notranslate"><span class="pre">Base</span></code> we could define the following types:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">export</span>
<span class="k">typedef</span> <span class="n">UINT32</span> <span class="n">ULONG</span><span class="p">;</span>

<span class="n">export</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_Pair</span> <span class="p">{</span>
   <span class="n">ULONG</span> <span class="n">first</span><span class="p">;</span>
   <span class="n">ULONG</span> <span class="n">second</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Pair</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_Mine</span> <span class="p">{</span>
   <span class="n">UINT8</span> <span class="n">f</span><span class="p">;</span>
   <span class="n">UINT8</span> <span class="n">g</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Mine</span><span class="p">;</span>
</pre></div>
</div>
<p>Note, the <code class="docutils literal notranslate"><span class="pre">export</span></code> qualifier indicate that these definitions may be
referenced from another module. Types that are not exproted (like
<code class="docutils literal notranslate"><span class="pre">Mine</span></code>) are not visible from another module.</p>
<p>In <code class="docutils literal notranslate"><span class="pre">Derived</span></code> we can use the type from <code class="docutils literal notranslate"><span class="pre">Base</span></code> by referring to it
using a fully qualified name of the form <code class="docutils literal notranslate"><span class="pre">&lt;MODULE</span> <span class="pre">NAME&gt;.&lt;IDENTIFIER&gt;</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">entrypoint</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_Triple</span> <span class="p">{</span>
   <span class="n">Base</span><span class="p">.</span><span class="n">Pair</span> <span class="n">pair</span><span class="p">;</span>
   <span class="n">Base</span><span class="p">.</span><span class="n">ULONG</span> <span class="n">third</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Triple</span><span class="p">;</span>
</pre></div>
</div>
<p>3d also allows defining module abbreviations. For example, using
<code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">B</span> <span class="pre">=</span> <span class="pre">Base</span></code> we introduce a shorter name for the module
<code class="docutils literal notranslate"><span class="pre">Base</span></code> for use within the current module.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">module</span> <span class="n">B</span> <span class="o">=</span> <span class="n">Base</span>
<span class="n">entrypoint</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_Quad</span> <span class="p">{</span>
   <span class="n">B</span><span class="p">.</span><span class="n">Pair</span> <span class="n">_12</span><span class="p">;</span>
   <span class="n">B</span><span class="p">.</span><span class="n">Pair</span> <span class="n">_34</span><span class="p">;</span>
<span class="p">}</span> <span class="n">Quad</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="a-fully-worked-example-tcp-segment-headers">
<h2>A fully worked example: TCP Segment Headers<a class="headerlink" href="#a-fully-worked-example-tcp-segment-headers" title="Permalink to this headline">¶</a></h2>
<p>The classic <a class="reference external" href="https://tools.ietf.org/html/rfc793">IETF RFC 793</a> from
1981 introduces the TCP protocol, including the format of the header
of TCP segments. The format has been extended slightly since then, to
accommodate new options and flags—this <a class="reference external" href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol#TCP_segment_structure">Wikipedia page</a>
provides a good summary.</p>
<p>Reproduced below is an ASCII depiction of the format of TCP
headers. In this section, we show how to specify this format in
3d. The full specification can be found <a class="reference external" href="https://github.com/project-everest/everparse/tree/master/src/3d/tests/tcpip/TCP.3d">here</a>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span> <span class="mi">0</span>                   <span class="mi">1</span>                   <span class="mi">2</span>                   <span class="mi">3</span>
 <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>          <span class="n">Source</span> <span class="n">Port</span>          <span class="o">|</span>       <span class="n">Destination</span> <span class="n">Port</span>        <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                        <span class="n">Sequence</span> <span class="n">Number</span>                        <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                    <span class="n">Acknowledgment</span> <span class="n">Number</span>                      <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>  <span class="n">Data</span> <span class="o">|</span>     <span class="o">|</span><span class="n">N</span><span class="o">|</span><span class="n">C</span><span class="o">|</span><span class="n">E</span><span class="o">|</span><span class="n">U</span><span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="n">P</span><span class="o">|</span><span class="n">R</span><span class="o">|</span><span class="n">S</span><span class="o">|</span><span class="n">F</span><span class="o">|</span>                               <span class="o">|</span>
<span class="o">|</span> <span class="n">Offset</span><span class="o">|</span> <span class="n">Rese</span><span class="o">|</span><span class="n">S</span><span class="o">|</span><span class="n">W</span><span class="o">|</span><span class="n">C</span><span class="o">|</span><span class="n">R</span><span class="o">|</span><span class="n">C</span><span class="o">|</span><span class="n">S</span><span class="o">|</span><span class="n">S</span><span class="o">|</span><span class="n">Y</span><span class="o">|</span><span class="n">I</span><span class="o">|</span>            <span class="n">Window</span>             <span class="o">|</span>
<span class="o">|</span>       <span class="o">|</span> <span class="n">rved</span><span class="o">|</span> <span class="o">|</span><span class="n">R</span><span class="o">|</span><span class="n">E</span><span class="o">|</span><span class="n">G</span><span class="o">|</span><span class="n">K</span><span class="o">|</span><span class="n">H</span><span class="o">|</span><span class="n">T</span><span class="o">|</span><span class="n">N</span><span class="o">|</span><span class="n">N</span><span class="o">|</span>                               <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>           <span class="n">Checksum</span>            <span class="o">|</span>         <span class="n">Urgent</span> <span class="n">Pointer</span>        <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                    <span class="n">Options</span>                    <span class="o">|</span>    <span class="n">Padding</span>    <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="o">|</span>                             <span class="n">data</span>                              <span class="o">|</span>
<span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</pre></div>
</div>
<p>Each <code class="docutils literal notranslate"><span class="pre">-</span></code> in the diagram represents a single bit, with fioelds
separated by vertical bars <code class="docutils literal notranslate"><span class="pre">|</span></code>.</p>
<p>The main subtle element of the specification is the handling of the
<code class="docutils literal notranslate"><span class="pre">DataOffset</span></code> field. It is a 4-bit value representing an offset from
the beginning of the segment, in 32-bit increments, of the start of
the <code class="docutils literal notranslate"><span class="pre">data</span></code> field. The <code class="docutils literal notranslate"><span class="pre">Options</span></code> and <code class="docutils literal notranslate"><span class="pre">Padding</span></code> fields are
optional, so the <code class="docutils literal notranslate"><span class="pre">DataOffset</span></code> field is used to encode the size of
the <code class="docutils literal notranslate"><span class="pre">Options</span></code> field. As such, <code class="docutils literal notranslate"><span class="pre">DataOffset</span></code> is always at least
<code class="docutils literal notranslate"><span class="pre">5</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Options</span></code> field itself is an array of tagged unions,
representing various kinds of options. Padding and the end of the
options array ensures that the <code class="docutils literal notranslate"><span class="pre">data</span></code> fields is always begins at a
multiple of 32-bits from the start of the segment.</p>
<p>Additionally, semantic constraints restrict the values of the fields
depending on the values of some other fields. For example, the
Acknowledgement number can only be non-zero when the <code class="docutils literal notranslate"><span class="pre">ACK</span></code> bit is
set.</p>
<p>To specify the type of a TCP header, we begin by defining some basic
types.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="n">UINT16</span> <span class="n">PORT</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">UINT32</span> <span class="n">SEQ_NUMBER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">UINT32</span> <span class="n">ACK_NUMBER</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">UINT16</span> <span class="n">WINDOW</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">UINT16</span> <span class="n">CHECK_SUM</span><span class="p">;</span>
<span class="k">typedef</span> <span class="n">UINT16</span> <span class="n">URGENT_PTR</span><span class="p">;</span>
</pre></div>
</div>
<p>The source and destination port each occupy 16 bits and are
represented by a <code class="docutils literal notranslate"><span class="pre">UINT16</span></code>; the sequence and acknowledgment number
fields are <code class="docutils literal notranslate"><span class="pre">UINT32</span></code> etc.</p>
<p>Next, we define the various kind of options that are allowed. Every
option begins with an option kind tag, an 8-bit value. Depending on
the option kind, a variable number of bits of an option value can
follow. The permitted option kinds are:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define OPTION_KIND_END_OF_OPTION_LIST 0x00</span>
<span class="cp">#define OPTION_KIND_NO_OPERATION 0x01</span>
<span class="cp">#define OPTION_KIND_MAX_SEG_SIZE 0x02</span>
<span class="cp">#define OPTION_KIND_WINDOW_SCALE 0x03</span>
<span class="cp">#define OPTION_KIND_SACK_PERMITTED 0x04</span>
<span class="cp">#define OPTION_KIND_SACK 0x05</span>
<span class="cp">#define OPTION_KIND_TIMESTAMP 0x08</span>
</pre></div>
</div>
<p>An <code class="docutils literal notranslate"><span class="pre">OPTION</span></code> is parameterized by a boolean, <code class="docutils literal notranslate"><span class="pre">MaxSegSizeAllowed</span></code>,
which constraints when the <code class="docutils literal notranslate"><span class="pre">OPTION_KIND_MAX_SEG_SIZE</span></code> is allowed to
be present—it turns out, the <code class="docutils literal notranslate"><span class="pre">SYN</span></code> bit in the header must be set
for this option to be allowed. The general shape of an <code class="docutils literal notranslate"><span class="pre">OPTION</span></code> is
as below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_OPTION</span><span class="p">(</span><span class="n">Bool</span> <span class="n">MaxSegSizeAllowed</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">UINT8</span> <span class="n">OptionKind</span><span class="p">;</span>
    <span class="n">OPTION_PAYLOAD</span><span class="p">(</span><span class="n">OptionKind</span><span class="p">,</span> <span class="n">MaxSegSizeAllowed</span><span class="p">)</span> <span class="n">OptionPayload</span><span class="p">;</span>
<span class="p">}</span> <span class="n">OPTION</span><span class="p">;</span>
</pre></div>
</div>
<p>We have an <code class="docutils literal notranslate"><span class="pre">OptionKind</span></code> field followed by an <code class="docutils literal notranslate"><span class="pre">OptionPayload</span></code> that
depends on the <code class="docutils literal notranslate"><span class="pre">OptionKind</span></code> and the <code class="docutils literal notranslate"><span class="pre">MaxSegSizeAllowed</span></code> flag.</p>
<p>Next, to define the <code class="docutils literal notranslate"><span class="pre">OPTION_PAYLOAD</span></code> type, we use a <code class="docutils literal notranslate"><span class="pre">casetype</span></code>, as
shown below.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">casetype</span> <span class="nf">_OPTION_PAYLOAD</span><span class="p">(</span><span class="n">UINT8</span> <span class="n">OptionKind</span><span class="p">,</span> <span class="n">Bool</span> <span class="n">MaxSegSizeAllowed</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">switch</span><span class="p">(</span><span class="n">OptionKind</span><span class="p">)</span>
  <span class="p">{</span>
   <span class="k">case</span> <span class="nl">OPTION_KIND_END_OF_OPTION_LIST</span><span class="p">:</span>
     <span class="n">unit</span> <span class="n">EndOfList</span><span class="p">;</span>

   <span class="k">case</span> <span class="nl">OPTION_KIND_NO_OPERATION</span><span class="p">:</span>
     <span class="n">unit</span> <span class="n">Noop</span><span class="p">;</span>

   <span class="k">case</span> <span class="nl">OPTION_KIND_MAX_SEG_SIZE</span><span class="p">:</span>
     <span class="n">MAX_SEG_SIZE_PAYLOAD</span><span class="p">(</span><span class="n">MaxSegSizeAllowed</span><span class="p">)</span> <span class="n">MaxSegSizePayload</span><span class="p">;</span>

   <span class="k">case</span> <span class="nl">OPTION_KIND_WINDOW_SCALE</span><span class="p">:</span>
     <span class="n">WINDOW_SCALE_PAYLOAD</span> <span class="n">WindowScalePayload</span><span class="p">;</span>

   <span class="k">case</span> <span class="nl">OPTION_KIND_SACK_PERMITTED</span><span class="p">:</span>
     <span class="n">UINT8</span> <span class="n">SackPermittedPayload</span><span class="p">;</span>

   <span class="k">case</span> <span class="nl">OPTION_KIND_SACK</span><span class="p">:</span>
     <span class="n">SELECTIVE_ACK_PAYLOAD</span> <span class="n">SelectiveAckPayload</span><span class="p">;</span>

   <span class="k">case</span> <span class="nl">OPTION_KIND_TIMESTAMP</span><span class="p">:</span>
     <span class="n">TIMESTAMP_PAYLOAD</span> <span class="n">TimestampPayload</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span> <span class="n">OPTION_PAYLOAD</span><span class="p">;</span>
</pre></div>
</div>
<p>In the first two cases of <code class="docutils literal notranslate"><span class="pre">OptionKind</span></code>, no payload is expected. The
<code class="docutils literal notranslate"><span class="pre">unit</span></code> type in 3d is an empty type—it consumes no space in the
message format.</p>
<p>For <code class="docutils literal notranslate"><span class="pre">OPTION_KIND_MAX_SEG_SIZE</span></code>, we have the following payload—the
use of the <code class="docutils literal notranslate"><span class="pre">where`</span> <span class="pre">constraint</span> <span class="pre">ensures</span> <span class="pre">that</span> <span class="pre">this</span> <span class="pre">case</span> <span class="pre">is</span> <span class="pre">present</span> <span class="pre">only</span>
<span class="pre">when</span> <span class="pre">`MaxSegSizeAllowed</span> <span class="pre">==</span> <span class="pre">true</span></code>. The payload is a length field (4
bytes) and a 2-byte <code class="docutils literal notranslate"><span class="pre">MaxSegSize</span></code> value.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_MAX_SEG_SIZE_PAYLOAD</span><span class="p">(</span><span class="n">Bool</span> <span class="n">MaxSegSizeAllowed</span><span class="p">)</span>
<span class="n">where</span> <span class="n">MaxSegSizeAllowed</span>
<span class="p">{</span>
  <span class="n">UINT8</span> <span class="n">Length</span>
  <span class="p">{</span>
    <span class="n">Length</span> <span class="o">==</span> <span class="mi">4</span>
  <span class="p">};</span>
  <span class="n">UINT16</span> <span class="n">MaxSegSize</span><span class="p">;</span>
<span class="p">}</span> <span class="n">MAX_SEG_SIZE_PAYLOAD</span><span class="p">;</span>
</pre></div>
</div>
<p>The other cases are relatively straightforward, where
<code class="docutils literal notranslate"><span class="pre">SELECTIVE_ACK_PAYLOAD</span></code> and <code class="docutils literal notranslate"><span class="pre">TIMESTAMP_PAYLOAD</span></code> illustrate the use
of variable length arrays.</p>
<p>Finally, we can assemble our top-level TCP header type, as shown
below. The specification of the options array is weaker than it could
be. It currently permits an end-of-options-list option to appear
anywhere in the Options list, rather than as just the last
element. This can be improved by using a more advanced combinator from
EverParse, however we leave it as is for simplicity of this example.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*++</span>
<span class="cm">  The top-level type of a TCP Header</span>

<span class="cm">  Arguments:</span>

<span class="cm">  * UINT32 SegmentLength, the size of the segment,</span>
<span class="cm">    including both header and data, passed in by the caller</span>

<span class="cm">  --*/</span>
<span class="n">export</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="nc">_TCP_HEADER</span><span class="p">(</span><span class="n">UINT32</span> <span class="n">SegmentLength</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">PORT</span>            <span class="n">SourcePort</span><span class="p">;</span>
  <span class="n">PORT</span>            <span class="n">DestinationPort</span><span class="p">;</span>
  <span class="n">SEQ_NUMBER</span>      <span class="n">SeqNumber</span><span class="p">;</span>
  <span class="n">ACK_NUMBER</span>      <span class="n">AckNumber</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">DataOffset</span><span class="p">:</span><span class="mi">4</span>
  <span class="p">{</span> <span class="c1">//DataOffset is in units of 32 bit words</span>
    <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">DataOffset</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="c1">//DataOffset points after the static fields</span>
    <span class="n">DataOffset</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">&lt;=</span> <span class="n">SegmentLength</span> <span class="c1">//and within the current segment</span>
  <span class="p">};</span>
  <span class="n">UINT16</span>          <span class="nl">Reserved</span><span class="p">:</span><span class="mi">3</span>
  <span class="p">{</span>
    <span class="n">Reserved</span> <span class="o">==</span> <span class="mi">0</span> <span class="c1">//Reserved bytes are unused</span>
  <span class="p">};</span>
  <span class="n">UINT16</span>          <span class="nl">NS</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">CWR</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">ECE</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">URG</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">ACK</span><span class="p">:</span><span class="mi">1</span>
  <span class="p">{</span>
    <span class="n">AckNumber</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
    <span class="n">ACK</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">//AckNumber can only be set if the ACK flag is set</span>
  <span class="p">}</span> <span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">PSH</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">RST</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">SYN</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">UINT16</span>          <span class="nl">FIN</span><span class="p">:</span><span class="mi">1</span><span class="p">;</span>
  <span class="n">WINDOW</span>          <span class="n">Window</span><span class="p">;</span>
  <span class="n">CHECK_SUM</span>       <span class="n">CheckSum</span><span class="p">;</span>
  <span class="n">URGENT_PTR</span>      <span class="n">UrgentPointer</span>
  <span class="p">{</span>
    <span class="n">UrgentPointer</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
    <span class="n">URG</span> <span class="o">==</span> <span class="mi">1</span> <span class="c1">//UrgentPointer can only be set if the URG flag is set</span>
  <span class="p">};</span>
  <span class="c1">//The SYN=1 condition indicates when MAX_SEG_SIZE option can be received</span>
  <span class="c1">//This is an array of options consuming</span>
  <span class="n">OPTION</span><span class="p">(</span><span class="n">SYN</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>  <span class="n">Options</span><span class="p">[</span><span class="o">:</span><span class="n">byte</span><span class="o">-</span><span class="n">size</span> <span class="p">(</span><span class="n">DataOffset</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="p">)];</span>
  <span class="n">UINT8</span>           <span class="n">Data</span><span class="p">[</span><span class="n">SegmentLength</span> <span class="o">-</span> <span class="p">(</span><span class="n">DataOffset</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)];</span>
<span class="p">}</span> <span class="n">TCP_HEADER</span><span class="p">;</span>
</pre></div>
</div>
<p>The type is parameterized by <code class="docutils literal notranslate"><span class="pre">SegmentLength</span></code>, the size in bytes
determined by the caller of the entire segment, including the header
and the data.</p>
<p>The first four fields, <code class="docutils literal notranslate"><span class="pre">SourcePort</span></code>, <code class="docutils literal notranslate"><span class="pre">DestinationPort</span></code>,
<code class="docutils literal notranslate"><span class="pre">SeqNumber</span></code> and <code class="docutils literal notranslate"><span class="pre">AckNumber</span></code> are straightforward.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">DataOffset</span></code> field is 4-bit value constrained to point beyond
the static fields of the header. Here <code class="docutils literal notranslate"><span class="pre">sizeof(this)</span></code> is a 3d
compile-time constant referring to the size of the non-variable length
prefix of the current type, i.e., the sum of the length in bytes of
all the fields up to the <code class="docutils literal notranslate"><span class="pre">Options</span></code> field. In this case, that number
is <code class="docutils literal notranslate"><span class="pre">20</span></code>. <code class="docutils literal notranslate"><span class="pre">DataOffset</span></code> is also constrained to reference an offset
within the curent segment.</p>
<p>Next, we have 3 reserved bits, following by 1 bit each for the 9
flags. The <code class="docutils literal notranslate"><span class="pre">Ack</span></code> flag is interesting, since its constraints states
that the <code class="docutils literal notranslate"><span class="pre">AckNumber</span></code> can be non-zero only if the <code class="docutils literal notranslate"><span class="pre">Ack</span></code> bit is set.</p>
<p>Then, we have a <code class="docutils literal notranslate"><span class="pre">Window</span></code> and <code class="docutils literal notranslate"><span class="pre">CheckSum</span></code>, both of which are
straightforward. Note, we do not specify the <code class="docutils literal notranslate"><span class="pre">CheckSum</span></code> as part of
the format—that’s up to an application-specific check to
confirm. Alternatively, one could check this using a user-provided
action callback, though this is not yet supported.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">UrgentPointer</span></code> field is similar to <code class="docutils literal notranslate"><span class="pre">AckNumber</span></code> in that it can
only be non-zero when the <code class="docutils literal notranslate"><span class="pre">URG</span></code> flag is set.</p>
<p>Then, we have an <code class="docutils literal notranslate"><span class="pre">Options</span></code> array, using the condition <code class="docutils literal notranslate"><span class="pre">SYN==1</span></code> to
determine the <code class="docutils literal notranslate"><span class="pre">MaxSegSizeAllowed</span></code> condition. The size in bytes of
the options array is variable and includes also the padding field, to
ensure 32-bit alignment. Note, this type is little too permissive, as
it will permit options arrays where the end-of-list option kind is not
necessarily only the last element.</p>
<p>Finally, we have the data field itself, whose byte size is bytes is
the computed expression.</p>
</div>
</div>


           </div>
           
          </div>

          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="3d.html" class="btn btn-neutral float-left" title="3d: Dependent Data Descriptions for Verified Validation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Microsoft Research.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>